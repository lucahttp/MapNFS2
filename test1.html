<!DOCTYPE html>
<html lang="en">

<head>
  <title>NFS SUC</title>
  <meta property="og:description" content="Use a custom style layer with three.js to add a 3D model to the map." />
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts: Orbitron for numbers/tech, Rajdhani for body -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;600;700&display=swap"
    rel="stylesheet">

  <!-- MapLibre -->
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.14.0/dist/maplibre-gl.js'></script>

  <!-- Turf.js for logic -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      font-family: 'Rajdhani', sans-serif;
      overflow: hidden;
      color: #00f3ff;
    }

    html,
    body,
    #map {
      height: 100%;
    }

    /* --- HUD AND UI STYLES --- */
    :root {
      --nfs-cyan: #00f3ff;
      --nfs-pink: #ff0055;
      --nfs-yellow: #ffe600;
      --nfs-dark: #0a0f1e;
      --nfs-dark-trans: rgba(10, 15, 30, 0.95);
      --hud-skew: -15deg;
    }

    .hud-layer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      box-sizing: border-box;
    }

    .hud-element {
      pointer-events: auto;
    }

    .top-bar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 100%);
    }

    .bottom-bar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 20px;
      box-sizing: border-box;
      background: linear-gradient(0deg, rgba(0, 0, 0, 0.9) 0%, rgba(0, 0, 0, 0) 100%);
    }

    /* Nav Hub */
    .nav-hub {
      position: relative;
      width: 350px;
      max-width: 100%;
    }

    .nav-input-container {
      position: relative;
      transform: skewX(var(--hud-skew));
      background: var(--nfs-dark-trans);
      border: 2px solid var(--nfs-cyan);
      padding: 5px;
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
    }

    .nav-label {
      position: absolute;
      top: -18px;
      left: 10px;
      font-size: 0.8rem;
      color: var(--nfs-yellow);
      font-weight: 700;
      text-shadow: 0 0 5px var(--nfs-yellow);
    }

    input.hud-input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 1.2rem;
      padding: 10px 20px;
      text-transform: uppercase;
      outline: none;
      transform: skewX(15deg);
    }

    input.hud-input::placeholder {
      color: rgba(0, 243, 255, 0.5);
    }

    .search-results {
      position: absolute;
      top: 110%;
      left: 0;
      width: 100%;
      background: var(--nfs-dark-trans);
      border: 1px solid var(--nfs-cyan);
      max-height: 250px;
      overflow-y: auto;
      display: none;
      transform: skewX(var(--hud-skew));
    }

    .result-item {
      padding: 12px 15px;
      border-bottom: 1px solid rgba(0, 243, 255, 0.2);
      color: #fff;
      cursor: pointer;
      transform: skewX(15deg);
      transition: background 0.2s;
      font-size: 1.1rem;
    }

    .result-item:hover {
      background: rgba(0, 243, 255, 0.2);
      color: var(--nfs-yellow);
    }

    /* Route Panel */
    .route-panel {
      position: absolute;
      top: 80px;
      left: 20px;
      width: 350px;
      max-width: 90%;
      background: var(--nfs-dark-trans);
      border: 2px solid var(--nfs-yellow);
      transform: skewX(var(--hud-skew));
      padding: 15px;
      display: none;
      box-shadow: 0 0 20px rgba(255, 230, 0, 0.2);
    }

    .route-row {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      transform: skewX(15deg);
    }

    .route-label {
      width: 50px;
      font-weight: bold;
      color: var(--nfs-cyan);
    }

    .route-input-box {
      flex: 1;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--nfs-cyan);
      padding: 5px;
    }

    .route-input-box input {
      width: 100%;
      background: transparent;
      border: none;
      color: #fff;
      font-family: 'Rajdhani';
      font-size: 1rem;
      outline: none;
    }

    .btn-go {
      width: 100%;
      background: var(--nfs-pink);
      border: none;
      color: #fff;
      font-family: 'Orbitron';
      font-size: 1.2rem;
      padding: 10px;
      margin-top: 10px;
      cursor: pointer;
      text-transform: uppercase;
      font-weight: 900;
      transform: skewX(15deg);
      transition: 0.2s;
    }

    .btn-go:hover {
      background: #ff3377;
      box-shadow: 0 0 15px var(--nfs-pink);
    }

    /* Danger Widget */
    .danger-widget {
      display: none;
      background: rgba(255, 0, 85, 0.2);
      border: 2px solid var(--nfs-pink);
      padding: 10px 30px;
      transform: skewX(var(--hud-skew));
      box-shadow: 0 0 20px rgba(255, 0, 85, 0.4);
      animation: pulse-danger 1s infinite alternate;
    }

    .danger-text {
      color: var(--nfs-pink);
      font-family: 'Orbitron';
      font-weight: 900;
      font-size: 1.5rem;
      transform: skewX(15deg);
      text-transform: uppercase;
    }

    @keyframes pulse-danger {
      from {
        opacity: 0.6;
        box-shadow: 0 0 10px var(--nfs-pink);
      }

      to {
        opacity: 1;
        box-shadow: 0 0 30px var(--nfs-pink);
      }
    }

    /* History & Stats */
    .history-panel {
      background: var(--nfs-dark-trans);
      border-left: 4px solid var(--nfs-yellow);
      padding: 15px;
      max-width: 250px;
      transform: skewX(var(--hud-skew));
      margin-bottom: 10px;
    }

    .history-title {
      color: var(--nfs-yellow);
      font-family: 'Orbitron';
      font-size: 1rem;
      margin-bottom: 10px;
      transform: skewX(15deg);
    }

    .history-list {
      list-style: none;
      padding: 0;
      margin: 0;
      transform: skewX(15deg);
    }

    .history-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 230, 0, 0.2);
      cursor: pointer;
      font-size: 1rem;
      color: #ddd;
    }

    .history-item:hover {
      color: #fff;
      text-shadow: 0 0 5px var(--nfs-yellow);
    }

    .speed-cluster {
      position: relative;
      text-align: right;
      transform: skewX(var(--hud-skew));
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .speed-value {
      font-family: 'Orbitron';
      font-size: 6rem;
      font-weight: 900;
      color: #fff;
      line-height: 0.8;
      text-shadow: 0 0 20px var(--nfs-cyan);
    }

    .speed-label {
      font-family: 'Rajdhani';
      font-size: 1.5rem;
      color: var(--nfs-cyan);
      font-weight: 700;
      margin-right: 10px;
    }

    #car-canvas-container {
      width: 180px;
      height: 100px;
      margin-top: -20px;
      margin-right: -20px;
      opacity: 0.8;
      transform: skewX(15deg);
    }

    @media (max-width: 768px) {
      .speed-value {
        font-size: 4rem;
      }

      .nav-hub {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <script type="importmap">
    {
        "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/"
        }
    }
</script>

  <div id="map"></div>

  <!-- HUD -->
  <div class="hud-layer">
    <div class="top-bar">
      <div class="nav-hub hud-element">
        <div class="nav-input-container">
          <span class="nav-label">DESTINATION</span>
          <input type="text" id="nav-input" class="hud-input" placeholder="SEARCH..." />
        </div>
        <div class="search-results" id="search-results"></div>
        <div class="route-panel" id="route-panel">
          <div class="route-row"><span class="route-label">FROM:</span>
            <div class="route-input-box"><input type="text" id="start-input" value="Current Location" /></div>
          </div>
          <div class="route-row"><span class="route-label">TO:</span>
            <div class="route-input-box"><input type="text" id="end-input" readonly /></div>
          </div>
          <button class="btn-go" onclick="startNavigation()">INITIATE ROUTE</button>
          <div class="search-results" id="start-search-results" style="top: 100%; display:none;"></div>
        </div>
      </div>
      <div class="danger-widget hud-element" id="danger-alert">
        <div class="danger-text">! HIGH RISK ZONE !</div>
      </div>
    </div>
    <div class="bottom-bar">
      <div class="history-panel hud-element">
        <div class="history-title">RECENT LOCATIONS</div>
        <ul class="history-list" id="history-list">
          <li class="history-item">SYSTEM READY...</li>
        </ul>
      </div>
      <div class="speed-cluster hud-element">
        <div class="speed-value">0</div>
        <div class="speed-label">KM/H</div>
        <div id="car-canvas-container"><canvas id="car-canvas"></canvas></div>
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

    // Global config
    const CONFIG = {
      defaultPos: [-58.3816, -34.6037], // Buenos Aires
      theme: { dark: '#0a0f1e', cyan: '#00f3ff', pink: '#ff0055' }
    };

    let currentState = { currentPos: null, startPos: null, endPos: null, endName: "" };

    // --- MAP SETUP ---
    const map = new maplibregl.Map({
      container: 'map',
      // Using OpenMapTiles or similar for the base style (NEON Style)
      style: {
        "version": 8,
        "glyphs": "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf",
        "sources": {
          "osm": { "type": "raster", "tiles": ["https://a.tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256, "attribution": "&copy; NFS Map" },
          "openmaptiles": { "type": "vector", "url": "https://api.maptiler.com/tiles/v3-openmaptiles/tiles.json?key=JZURWSSXaezauUK6D94q" }
        },
        "layers": [
          { "id": "background", "type": "background", "paint": { "background-color": "#050510" } },
          { "id": "water", "type": "fill", "source": "openmaptiles", "source-layer": "water", "paint": { "fill-color": "#001a2a" } },
          { "id": "road", "type": "line", "source": "openmaptiles", "source-layer": "transportation", "paint": { "line-color": "#00f3ff", "line-width": 1.5, "line-opacity": 0.4 } },
          { "id": "building-3d", "type": "fill-extrusion", "source": "openmaptiles", "source-layer": "building", "paint": { "fill-extrusion-color": "#0a0f1e", "fill-extrusion-height": ["get", "render_height"], "fill-extrusion-base": ["get", "render_min_height"], "fill-extrusion-opacity": 0.8 } }
        ]
      },
      zoom: 14,
      center: CONFIG.defaultPos,
      pitch: 60,
      canvasContextAttributes: { antialias: true }
    });

    // --- CUSTOM 3D LAYER ---
    const customLayer = {
      id: '3d-model-layer',
      type: 'custom',
      renderingMode: '3d',
      map: null,
      camera: null,
      scene: null,
      renderer: null,

      // Meshes
      gasStationMeshes: { tanks: null, straps1: null, straps2: null, rings: null },
      cameraMeshes: { pole: null, box: null },

      onAdd(map, gl) {
        this.map = map;
        this.camera = new THREE.Camera();
        this.scene = new THREE.Scene();

        // Lights
        const directionalLight = new THREE.DirectionalLight(0xffffff);
        directionalLight.position.set(0, -70, 100).normalize();
        this.scene.add(directionalLight);

        const directionalLight2 = new THREE.DirectionalLight(0xffffff);
        directionalLight2.position.set(0, 70, 100).normalize();
        this.scene.add(directionalLight2);

        const pointLight = new THREE.PointLight(0x00f3ff, 1, 1000);
        pointLight.position.set(0, 0, 500);
        this.scene.add(pointLight);

        this.renderer = new THREE.WebGLRenderer({
          canvas: map.getCanvas(),
          context: gl,
          antialias: true
        });
        this.renderer.autoClear = false;
        // CRITICAL: Set Pixel Ratio for sharp rendering on high-DPI screens
        this.renderer.setPixelRatio(window.devicePixelRatio);
      },

      render(gl, args) {
        let projectionMatrixArray = args && args.defaultProjectionData ? args.defaultProjectionData.mainMatrix : null;
        // Fallback if args is not structured as expected (older versions or variations)
        if (!projectionMatrixArray && Array.isArray(args)) projectionMatrixArray = args; // if args IS the matrix

        if (projectionMatrixArray) {
          const m = new THREE.Matrix4().fromArray(projectionMatrixArray);
          this.camera.projectionMatrix = m;
        }

        this.renderer.resetState();
        this.renderer.render(this.scene, this.camera);
        this.map.triggerRepaint();
      },

      updateGasStations(features) {
        if (!this.scene) return;

        // Clean up previous meshes
        const keys = ['tanks', 'straps1', 'straps2', 'rings', 'bands', 'text'];
        keys.forEach(k => { if (this.gasStationMeshes[k]) this.scene.remove(this.gasStationMeshes[k]); });
        if (this.gasStationMeshes.legs) this.scene.remove(this.gasStationMeshes.legs);

        // Clean up GLTF instances if any
        if (this.gasStationMeshes.scadInstances) {
          this.gasStationMeshes.scadInstances.forEach(im => this.scene.remove(im));
        }
        this.gasStationMeshes.scadInstances = [];

        const count = features.length;
        if (count === 0) return;

        const S = 0.05; // Scale

        // --- 1. TANK (Capsule) ---
        // Ref: CapsuleGeometry(160, 800, 8, 32)
        // Improved: 16 cap segments, 64 radial for smoothness
        const tankGeo = new THREE.CapsuleGeometry(160 * S, 800 * S, 16, 64);
        tankGeo.rotateZ(Math.PI / 2);
        tankGeo.translate(0, 0, 15);

        // Ref Material:
        // color: 0xFFD342, metalness: 0.3, roughness: 0.4, clearcoat: 0.5, clearcoatRoughness: 0.1
        const tankMat = new THREE.MeshPhysicalMaterial({
          color: 0xFFD342,
          metalness: 0.3,
          roughness: 0.4,
          clearcoat: 0.5,
          clearcoatRoughness: 0.1
        });

        // --- 2. BAND (White Cylinder) ---
        // Ref: CylinderGeometry(201, 201, 60, 64, 1, true)
        const bandGeo = new THREE.CylinderGeometry(201 * S, 201 * S, 60 * S, 128, 1, true); // 128 segs
        bandGeo.rotateZ(Math.PI / 2);
        bandGeo.translate(0, 0, 15);

        const bandMat = new THREE.MeshBasicMaterial({ color: 0xFFFFFF, side: THREE.DoubleSide });

        // --- 3. RING (Power Up) ---
        // Ref: TorusGeometry(187.5, 12.5, 32, 100)
        // Improved: 48 radial, 128 tubular
        const ringGeo = new THREE.TorusGeometry(187.5 * S, 12.5 * S, 48, 128);
        ringGeo.rotateY(Math.PI / 2);
        ringGeo.translate(0, 0, 15);

        // Ref Material:
        // color: 0xB200FF, metalness: 0.1, roughness: 0.05, transmission: 0.3
        // opacity: 0.5, transparent: true, emissive: 0x660099, emissiveIntensity: 0.6
        const ringMat = new THREE.MeshPhysicalMaterial({
          color: 0xB200FF,
          metalness: 0.1,
          roughness: 0.05,
          transmission: 0.3,
          thickness: 10,
          opacity: 0.5,
          transparent: true,
          depthWrite: false, // Critical for transparency
          emissive: 0x660099,
          emissiveIntensity: 0.6,
          side: THREE.DoubleSide
        });

        // --- 4. TEXT (GNC) ---
        // High-Res Canvas (2048x512) for crispy text
        const canvas = document.createElement('canvas');
        canvas.width = 2048; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'rgba(0,0,0,0)'; ctx.fillRect(0, 0, 2048, 512);
        ctx.fillStyle = '#0d0d0d';
        ctx.font = 'bold 320px "Arial Black", Arial'; // Larger font
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('GNC', 1024, 256);

        const textTex = new THREE.CanvasTexture(canvas);
        textTex.anisotropy = this.renderer.capabilities.getMaxAnisotropy();
        textTex.minFilter = THREE.LinearMenuItemFilter; // Better minification

        // Ref: CylinderGeometry(203, 203, 50, 32...)
        const textGeo = new THREE.CylinderGeometry(203 * S, 203 * S, 50 * S, 128, 1, true, -Math.PI / 6, Math.PI / 3);
        textGeo.rotateZ(Math.PI / 2);
        textGeo.rotateY(-Math.PI / 2);
        textGeo.translate(0, 0, 15);

        const textMat = new THREE.MeshBasicMaterial({
          map: textTex,
          transparent: true,
          side: THREE.DoubleSide
        });

        // --- INSTANCING ---
        this.gasStationMeshes.tanks = new THREE.InstancedMesh(tankGeo, tankMat, count);
        this.gasStationMeshes.bands = new THREE.InstancedMesh(bandGeo, bandMat, count);
        this.gasStationMeshes.rings = new THREE.InstancedMesh(ringGeo, ringMat, count);
        this.gasStationMeshes.text = new THREE.InstancedMesh(textGeo, textMat, count);

        const dummy = new THREE.Object3D();
        const color = new THREE.Color();

        features.forEach((f, i) => {
          const coords = f.geometry.coordinates;
          const mercator = maplibregl.MercatorCoordinate.fromLngLat(coords, 0);
          const scale = mercator.meterInMercatorCoordinateUnits();

          dummy.position.set(mercator.x, mercator.y, mercator.z || 0);
          dummy.scale.set(scale, -scale, scale);
          dummy.rotation.set(0, 0, 0);
          dummy.updateMatrix();

          this.gasStationMeshes.tanks.setMatrixAt(i, dummy.matrix);
          this.gasStationMeshes.bands.setMatrixAt(i, dummy.matrix);
          this.gasStationMeshes.rings.setMatrixAt(i, dummy.matrix);
          this.gasStationMeshes.text.setMatrixAt(i, dummy.matrix);

          // Set all to Reference Gold
          color.setHex(0xFFD342);
          this.gasStationMeshes.tanks.setColorAt(i, color);
        });

        this.gasStationMeshes.tanks.instanceMatrix.needsUpdate = true;
        this.gasStationMeshes.tanks.instanceColor.needsUpdate = true;
        this.gasStationMeshes.bands.instanceMatrix.needsUpdate = true;
        this.gasStationMeshes.rings.instanceMatrix.needsUpdate = true;
        this.gasStationMeshes.text.instanceMatrix.needsUpdate = true;

        this.scene.add(this.gasStationMeshes.tanks);
        this.scene.add(this.gasStationMeshes.bands);
        this.scene.add(this.gasStationMeshes.rings);
        this.scene.add(this.gasStationMeshes.text);

        console.log("3D Gas Stations Updated (Ref Exact Match - Optimized)");
      },

      updateCameras(features) {
        if (!this.scene) return;
        if (this.cameraMeshes.pole) this.scene.remove(this.cameraMeshes.pole);
        if (this.cameraMeshes.box) this.scene.remove(this.cameraMeshes.box);

        const count = features.length;
        if (count === 0) return;

        // ARCADE VISIBILITY: Huge Camera Tower
        const poleGeo = new THREE.CylinderGeometry(4, 4, 80, 8);
        poleGeo.rotateX(Math.PI / 2);
        poleGeo.translate(0, 0, 40);

        const boxGeo = new THREE.BoxGeometry(16, 16, 16);
        boxGeo.translate(0, 0, 80); // Top of pole

        // Neon Materials
        const mat = new THREE.MeshBasicMaterial({ color: 0xffffff });
        const boxMat = new THREE.MeshBasicMaterial({ color: 0x00f3ff });

        this.cameraMeshes.pole = new THREE.InstancedMesh(poleGeo, mat, count);
        this.cameraMeshes.box = new THREE.InstancedMesh(boxGeo, boxMat, count);

        const dummy = new THREE.Object3D();

        features.forEach((f, i) => {
          const coords = f.geometry.coordinates;
          const mercator = maplibregl.MercatorCoordinate.fromLngLat(coords, 0);
          const scale = mercator.meterInMercatorCoordinateUnits();

          dummy.position.set(mercator.x, mercator.y, mercator.z || 0);
          dummy.scale.set(scale, -scale, scale);
          dummy.updateMatrix();

          this.cameraMeshes.pole.setMatrixAt(i, dummy.matrix);
          this.cameraMeshes.box.setMatrixAt(i, dummy.matrix);
        });

        this.cameraMeshes.pole.instanceMatrix.needsUpdate = true;
        this.cameraMeshes.box.instanceMatrix.needsUpdate = true;

        this.scene.add(this.cameraMeshes.pole);
        this.scene.add(this.cameraMeshes.box);
        console.log("3D Cameras Updated: " + count + " (MEGA SCALE)");
      }
    };

    map.on('style.load', () => {
      map.addLayer(customLayer);
      // Load Data
      loadData();
    });

    map.on('load', () => {
      locateUser();
    });

    // --- DATA LOADING ---
    function loadData() {
      // Gas Stations
      fetch('./estaciones%20de%20servicio/estaciones_servicio_argentina.geojson')
        .then(res => res.json())
        .then(data => {
          customLayer.updateGasStations(data.features);
          // Interactive Transparent Layer
          if (!map.getSource('estaciones-src')) {
            map.addSource('estaciones-src', { type: 'geojson', data: data });
            map.addLayer({
              id: 'estaciones-hitbox',
              type: 'circle',
              source: 'estaciones-src',
              paint: { 'circle-radius': 15, 'circle-opacity': 0, 'circle-color': '#fff' }
            });

            map.on('click', 'estaciones-hitbox', (e) => {
              const props = e.features[0].properties;
              new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(`<b>${props.empresabandera}</b><br>${props.tipooperador}`)
                .addTo(map);
            });
            map.on('mouseenter', 'estaciones-hitbox', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'estaciones-hitbox', () => map.getCanvas().style.cursor = '');
          }
        });

      // Cameras
      fetch('./fotomultas/speed_cameras.geojson')
        .then(res => res.json())
        .then(data => {
          customLayer.updateCameras(data.features);
          if (!map.getSource('cameras-src')) {
            map.addSource('cameras-src', { type: 'geojson', data: data });
            map.addLayer({
              id: 'cameras-hitbox',
              type: 'circle',
              source: 'cameras-src',
              paint: { 'circle-radius': 10, 'circle-opacity': 0, 'circle-color': '#fff' }
            });
            map.on('click', 'cameras-hitbox', (e) => {
              const props = e.features[0].properties;
              new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(`<b>CAMERA</b><br>${props.velocidadPermitida || 'N/A'} KM/H`)
                .addTo(map);
            });
            map.on('mouseenter', 'cameras-hitbox', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'cameras-hitbox', () => map.getCanvas().style.cursor = '');
          }
        });

      // Danger Zones
      fetch('./villas/renabap-2023-12-06.geojson')
        .then(res => res.json())
        .then(data => {
          map.addSource('danger-zone', { type: 'geojson', data: data });
          map.addLayer({
            'id': 'danger-fill',
            'type': 'fill',
            'source': 'danger-zone',
            'paint': { 'fill-color': '#ff0055', 'fill-opacity': 0.3 }
          });
          map.on('click', 'danger-fill', (e) => {
            new maplibregl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(`<b>DANGER ZONE</b>`)
              .addTo(map);
          });
        }).catch(e => console.log(e));
    }

    // --- UTILS for HUD ---
    window.startNavigation = function () {
      alert("Nav init...");
    };

    function locateUser() {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(position => {
          const pos = [position.coords.longitude, position.coords.latitude];
          currentState.currentPos = pos;
          map.flyTo({ center: pos, zoom: 15 });
          new maplibregl.Marker({ color: '#00f3ff' }).setLngLat(pos).addTo(map);
        });
      }
    }

    // 3D Car Widget
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';

    const carCanvas = document.getElementById('car-canvas');
    if (carCanvas) {
      const renderer = new THREE.WebGLRenderer({ canvas: carCanvas, alpha: true, antialias: true });
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(45, 180 / 100, 0.1, 1000);
      camera.position.set(200, 100, 300); // Zoom out a bit for the model
      camera.lookAt(0, 0, 0);

      // Light for base visibility
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      let carGroup = new THREE.Group();
      scene.add(carGroup);

      const loader = new FBXLoader();
      loader.load('./assets/20251214021233_3c4724df.fbx', (object) => {
        // STYLE: Simplified Orange Lines (Technical Look)
        const lineMat = new THREE.LineBasicMaterial({
          color: 0xffa500, // Orange
        });

        object.traverse((child) => {
          if (child.isMesh) {
            // Create simplified edges (threshold 15 degrees)
            const edges = new THREE.EdgesGeometry(child.geometry, 15);
            const line = new THREE.LineSegments(edges, lineMat);

            // Add lines as a child of the mesh
            child.add(line);

            // Hide the original solid faces
            child.material = new THREE.MeshBasicMaterial({ visible: false });
          }
        });

        // Center and Scale
        const box = new THREE.Box3().setFromObject(object);
        const center = box.getCenter(new THREE.Vector3());
        const size = box.getSize(new THREE.Vector3());

        // Auto-scale to fit roughly in view
        const maxDim = Math.max(size.x, size.y, size.z);
        const scale = 150 / maxDim; // Target size 150 units

        object.position.x = -center.x; // Center it
        object.position.y = -center.y;
        object.position.z = -center.z;

        object.scale.set(scale, scale, scale);

        carGroup.add(object);
      }, undefined, (error) => {
        console.error("Error loading car FBX:", error);
      });

      function animateCar() {
        requestAnimationFrame(animateCar);
        if (carGroup) carGroup.rotation.y += 0.01;
        renderer.render(scene, camera);
      }
      animateCar();
    }

  </script>
</body>

</html>